<!doctype html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="JOHNGALTAZ ‚Äî –∫–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤: —Ñ–∏–ª—å—Ç—Ä—ã, –ø–æ–∏—Å–∫, —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ, –∏–∑–±—Ä–∞–Ω–Ω–æ–µ, –∫–æ—Ä–∑–∏–Ω–∞ –∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏/–∑–∞–∫–∞–∑–∞." />
  <title>–ö–∞—Ç–∞–ª–æ–≥ ‚Äî JOHNGALTAZ</title>

  <style>
    :root{
      --primary:#0B1416;
      --accent:#F85C58;
      --bg:#F6F6F3;
      --card:#ffffff;
      --muted:#666666;
      --line:#D6D6D6;
      --ok:#0f8a4b;
      --warn:#9a6a00;
      --shadow: 0 10px 30px rgba(11,20,22,.08);
      --radius: 16px;
      --radius2: 22px;
      --max: 1180px;
      --focus: 0 0 0 3px rgba(248,92,88,.25);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    html, body { overflow-x: hidden; }
    body{
      margin:0;
      min-width:320px;
      font-family:var(--font);
      color:var(--primary);
      background:var(--bg);
      line-height:1.4;
    }
    *, *::before, *::after { min-width: 0; }
    img, svg { max-width: 100%; height: auto; }

    a{color:inherit; text-decoration:none}
    button, input, select, textarea{font:inherit}
    a, button { -webkit-tap-highlight-color: transparent; }
    button { touch-action: manipulation; }

    .container{max-width:var(--max); margin:0 auto; padding:0 16px}

    .skip{position:absolute; left:-999px; top:auto; width:1px; height:1px; overflow:hidden}
    .skip:focus{left:16px; top:16px; width:auto; height:auto; padding:10px 12px; background:#fff; border-radius:12px; box-shadow:var(--shadow); z-index:9999}

    /* Header (same style as index) */
    header{
      position:sticky; top:0; z-index:50;
      background:rgba(246,246,243,.85);
      backdrop-filter:saturate(1.3) blur(10px);
      border-bottom:1px solid rgba(214,214,214,.6);
    }
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 0; flex-wrap:wrap; row-gap:10px;}
    .brand{display:flex; align-items:center; gap:12px; min-width:0; flex: 1 1 auto;}
    .logo{
      width:44px; height:44px; border-radius:12px;
      object-fit:cover; background:#fff; box-shadow:0 6px 16px rgba(11,20,22,.08);
    }
    .brand-title{display:flex; flex-direction:column; gap:2px; min-width:0}
    .brand-title b{letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .brand-title small{color:var(--muted); font-size:12px}

    .searchwrap{flex:1; display:flex; gap:10px; align-items:center; min-width:260px}
    .search{
      width:100%;
      display:flex; gap:8px; align-items:center;
      background:#fff; border:1px solid var(--line);
      border-radius:999px; padding:10px 12px; box-shadow: 0 6px 18px rgba(11,20,22,.05);
    }
    .search input{border:none; outline:none; width:100%; background:transparent;}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:8px 10px;
      color:var(--primary);
    }
    .chip select{border:none; outline:none; background:transparent; padding:0; margin:0; cursor:pointer;}

    .actions{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
    .iconbtn{
      position:relative;
      display:inline-flex; align-items:center; justify-content:center;
      width:42px; height:42px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(11,20,22,.05);
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
    }
    .iconbtn:hover{transform:translateY(-1px)}
    .iconbtn:focus{outline:none; box-shadow:var(--focus), 0 6px 18px rgba(11,20,22,.05)}
    .badge{
      position:absolute; top:-6px; right:-6px;
      min-width:18px; height:18px;
      padding:0 5px;
      background:var(--accent); color:#fff; border-radius:999px;
      font-size:11px; display:flex; align-items:center; justify-content:center;
      border:2px solid var(--bg);
    }
    .hamb{display:none}

    nav{padding:0 0 10px 0; display:block}
    .navrow{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .navlinks{display:flex; gap:10px; flex-wrap:wrap}
    .navlinks a{
      padding:8px 12px; border-radius:999px;
      border:1px solid rgba(214,214,214,.0);
      color:var(--primary);
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .navlinks a:hover{background:#fff; border-color:var(--line); transform:translateY(-1px)}
    .navright{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:12px 16px;
      min-height:44px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-weight:700;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
    }
    .btn:hover{border-color:rgba(214,214,214,.85); transform:translateY(-1px)}
    .btn:focus{outline:none; box-shadow:var(--focus)}
    .btn.primary{background:var(--accent); border-color:var(--accent); color:#fff; box-shadow: 0 10px 26px rgba(248,92,88,.25)}
    .btn.primary:hover{box-shadow: 0 14px 34px rgba(248,92,88,.28)}

    .cta{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:12px 16px;
      min-height:44px;
      border-radius:999px;
      background:var(--accent); color:#fff; border:1px solid var(--accent);
      cursor:pointer; box-shadow: 0 10px 26px rgba(248,92,88,.25);
      font-weight:800;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .cta:hover{transform:translateY(-1px); box-shadow: 0 14px 34px rgba(248,92,88,.28)}
    .cta:focus{outline:none; box-shadow:var(--focus), 0 14px 34px rgba(248,92,88,.28)}

    /* Page layout */
    main{padding:18px 0 80px}
    .pagehead{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      margin:10px 0 12px;
      flex-wrap:wrap;
    }
    .pagehead h1{margin:0; font-size: clamp(20px, 2.2vw, 28px); line-height:1.15}
    .pagehead p{margin:6px 0 0; color:var(--muted); font-size:13px; max-width:70ch}
    .crumbs{display:flex; gap:8px; align-items:center; color:var(--muted); font-size:12px}

    .layout{
      display:grid;
      grid-template-columns: minmax(0, 320px) minmax(0, 1fr);
      gap:12px;
      align-items:start;
    }

    .card{
      background:#fff;
      border:1px solid rgba(214,214,214,.75);
      border-radius:var(--radius2);
      box-shadow:var(--shadow);
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .card:hover{box-shadow: 0 14px 40px rgba(11,20,22,.10)}
    .pad{padding:14px}

    /* Filters */
    .filters{position:sticky; top:106px;}
    .fhead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .fhead b{font-size:15px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      background:rgba(246,246,243,.6);
      border-radius:999px;
      padding:7px 10px;
      font-size:12px;
      color:var(--primary);
      white-space:nowrap;
    }
    .group{border-top:1px solid rgba(214,214,214,.65); padding-top:12px; margin-top:12px}
    .group:first-child{border-top:none; padding-top:0; margin-top:0}
    .gtitle{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px}
    .gtitle b{font-size:13px}
    .gtitle button{
      border:none; background:transparent; cursor:pointer;
      padding:6px 8px; border-radius:12px;
    }
    .gtitle button:focus{outline:none; box-shadow:var(--focus)}
    .rows{display:flex; flex-direction:column; gap:10px}
    label{font-size:12px; color:var(--muted)}
    .field input, .field select{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      outline:none;
      background:#fff;
    }
    .field input:focus, .field select:focus{box-shadow:var(--focus); border-color:rgba(248,92,88,.45)}
    .range2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .rangeval{display:flex; justify-content:space-between; gap:10px; font-size:12px; color:var(--muted)}
    .switch{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border:1px solid rgba(214,214,214,.75);
      border-radius:14px;
      background:linear-gradient(180deg, #fff, rgba(246,246,243,.35));
    }
    .switch input{width:18px; height:18px}
    .tagrow{display:flex; gap:8px; flex-wrap:wrap}
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:7px 10px;
      font-size:12px;
      cursor:pointer;
    }
    .tag.on{border-color:rgba(248,92,88,.55); box-shadow:0 0 0 3px rgba(248,92,88,.14)}
    .mini{padding:8px 10px; min-height:38px; font-weight:700}

    /* Results top bar */
    .toolbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 14px;
      flex-wrap:wrap;
    }
    .toolbar .left{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .toolbar .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .count{color:var(--muted); font-size:12px}
    .sort{display:flex; align-items:center; gap:8px}
    .sort select{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      outline:none;
    }
    .sort select:focus{box-shadow:var(--focus); border-color:rgba(248,92,88,.45)}

    /* Products grid */
    .products{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap:12px;
      padding:0 14px 14px;
    }
    .p{
      border:1px solid rgba(214,214,214,.75);
      border-radius:var(--radius2);
      overflow:hidden;
      background:linear-gradient(180deg, #fff, rgba(246,246,243,.35));
      box-shadow: 0 10px 30px rgba(11,20,22,.06);
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .p:hover{transform:translateY(-2px); box-shadow: 0 14px 40px rgba(11,20,22,.10)}
    .pimg{
      width:100%;
      aspect-ratio: 4 / 3;
      object-fit:cover;
      background:#fff;
    }
    .pbody{padding:12px}
    .pname{margin:0; font-size:14px; line-height:1.25; overflow-wrap:anywhere}
    .psku{margin-top:4px; color:var(--muted); font-size:12px}
    .pmeta{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .chip2{
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid rgba(214,214,214,.8);
      border-radius:999px;
      padding:6px 9px;
      font-size:12px;
      background:#fff;
      color:var(--primary);
      white-space:nowrap;
    }
    .chip2.ok{border-color:rgba(15,138,75,.35); background:rgba(15,138,75,.06)}
    .chip2.warn{border-color:rgba(154,106,0,.35); background:rgba(154,106,0,.06)}
    .specs{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
      color:var(--muted);
      font-size:12px;
    }
    .specs div{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .price{
      display:flex; align-items:baseline; gap:10px;
      margin-top:10px;
    }
    .price b{font-size:16px}
    .price s{color:var(--muted); font-size:12px}
    .pactions{
      margin-top:12px;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .pactions .btn, .pactions .cta{flex:1 1 auto}
    .iconbar{display:flex; gap:10px; margin-top:10px}
    .iconbar .iconbtn{width:42px; height:42px}
    .sticker{
      position:absolute; top:10px; left:10px;
      background:var(--accent); color:#fff;
      font-size:12px; font-weight:800;
      padding:6px 10px; border-radius:999px;
      box-shadow: 0 10px 26px rgba(248,92,88,.25);
    }
    .preorderline{
      margin-top:10px;
      font-size:12px;
      color:var(--primary);
      border-left:3px solid var(--accent);
      padding:8px 10px;
      border-radius:12px;
      background:rgba(248,92,88,.07);
    }

    /* Drawer / Modal */
    .overlay{
      position:fixed; inset:0;
      background:rgba(11,20,22,.45);
      display:none;
      z-index:200;
    }
    .overlay.show{display:block}

    .drawer{
      position:fixed; top:0; right:0;
      width:min(460px, 92vw);
      height:100%;
      background:#fff;
      border-left:1px solid rgba(214,214,214,.75);
      box-shadow: -20px 0 60px rgba(11,20,22,.18);
      transform: translateX(110%);
      transition: transform .18s ease;
      z-index:210;
      display:flex; flex-direction:column;
    }
    .drawer.show{transform: translateX(0)}
    .drawer header{
      position:sticky; top:0;
      background:#fff; border-bottom:1px solid rgba(214,214,214,.65);
      padding:12px 14px;
    }
    .drawer h3{margin:0; font-size:16px}
    .drawer .content{padding:12px 14px; overflow:auto; flex:1}
    .row{display:flex; justify-content:space-between; gap:10px; align-items:center}
    .close{border:none; background:transparent; cursor:pointer; font-size:18px; padding:6px 10px; border-radius:12px}
    .close:focus{outline:none; box-shadow:var(--focus)}
    .item{
      border:1px solid rgba(214,214,214,.65);
      border-radius:16px;
      padding:10px;
      display:grid;
      grid-template-columns:64px 1fr;
      gap:10px;
      margin-bottom:10px;
      background:linear-gradient(180deg, #fff, rgba(246,246,243,.35));
    }
    .thumb{
      width:64px; height:64px; border-radius:14px; object-fit:cover; background:#fff;
      border:1px solid rgba(214,214,214,.65)
    }
    .item b{display:block; font-size:13px}
    .item small{display:block; color:var(--muted); font-size:12px}
    .qty{display:flex; align-items:center; gap:8px; margin-top:8px; flex-wrap:wrap}
    .qty button{width:30px; height:30px; border-radius:12px; border:1px solid var(--line); background:#fff; cursor:pointer}
    .qty input{width:56px; text-align:center; padding:8px; border-radius:12px; border:1px solid var(--line)}
    .totals{
      border-top:1px solid rgba(214,214,214,.65);
      padding:12px 14px;
      background:rgba(246,246,243,.55);
    }
    .totals .cta{width:100%}

    .modal{
      position:fixed; inset:0;
      display:none;
      z-index:260;
    }
    .modal.show{display:block}
    .modal .pane{
      position:absolute; inset:auto 0 0 0;
      margin:auto;
      max-width:min(920px, 96vw);
      max-height:min(88vh, 740px);
      top:6vh;
      background:#fff;
      border:1px solid rgba(214,214,214,.75);
      border-radius:var(--radius2);
      box-shadow: 0 30px 80px rgba(11,20,22,.22);
      overflow:hidden;
      left:0; right:0;
      display:flex; flex-direction:column;
    }
    .mhead{
      padding:12px 14px;
      border-bottom:1px solid rgba(214,214,214,.65);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      background:rgba(246,246,243,.55);
    }
    .mhead b{font-size:14px}
    .mbody{
      padding:14px;
      overflow:auto;
    }
    .pdp{
      display:grid;
      grid-template-columns: minmax(0, 360px) minmax(0, 1fr);
      gap:12px;
      align-items:start;
    }
    .gal{
      border:1px solid rgba(214,214,214,.75);
      border-radius:var(--radius2);
      overflow:hidden;
      background:linear-gradient(180deg, #fff, rgba(246,246,243,.35));
    }
    .gal img{width:100%; aspect-ratio: 4/3; object-fit:cover}
    .pdp h2{margin:0; font-size:18px; line-height:1.2}
    .pdp .muted{color:var(--muted)}
    .pdp .box{
      border:1px solid rgba(214,214,214,.75);
      border-radius:var(--radius2);
      padding:12px;
      background:linear-gradient(180deg, #fff, rgba(246,246,243,.35));
    }
    .tbl{width:100%; border-collapse:collapse; font-size:13px}
    .tbl td{padding:8px 0; border-bottom:1px dashed rgba(214,214,214,.8)}
    .tbl td:first-child{color:var(--muted); width:42%}
    .variantrow{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px}
    .variantrow select{width:100%; padding:11px 12px; border-radius:14px; border:1px solid var(--line); outline:none}
    .variantrow select:focus{box-shadow:var(--focus); border-color:rgba(248,92,88,.45)}
    .pdpactions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .pdpactions .btn, .pdpactions .cta{flex:1 1 auto}
    .warnbox{
      margin-top:10px;
      border-left:3px solid var(--accent);
      padding:10px 12px;
      border-radius:12px;
      background:rgba(248,92,88,.07);
      font-size:13px;
    }
    .docs{
      display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;
    }
    .doclink{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:9px 12px;
      font-size:13px;
    }

    /* Checkout section */
    .checkoutWrap{margin-top:12px}
    .checkoutHead{display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .checkoutHead h2{margin:0; font-size:18px}
    .checkoutHead p{margin:6px 0 0; color:var(--muted); font-size:13px}
    .formgrid{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px}
    .field textarea{width:100%; padding:11px 12px; border-radius:14px; border:1px solid var(--line); outline:none; background:#fff}
    .field textarea:focus{box-shadow:var(--focus); border-color:rgba(248,92,88,.45)}
    .b2bBox{
      margin-top:10px;
      border:1px solid rgba(214,214,214,.75);
      border-radius:var(--radius2);
      padding:12px;
      background:linear-gradient(180deg, #fff, rgba(246,246,243,.35));
    }
    .b2bBox .formgrid{margin-top:10px}
    .file{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border:1px solid rgba(214,214,214,.75);
      border-radius:14px;
      background:#fff;
    }
    .file input{max-width:100%}
    .help{color:var(--muted); font-size:12px; margin-top:8px}
    /* –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ (–∫–∞–∫ —Ç—ã –ø—Ä–æ—Å–∏–ª) */
    .help, #urlHint, #priceHint{display:none !important;}

    /* Floating WhatsApp */
    .float-wa{
      position:fixed;
      right:16px;
      bottom:16px;
      z-index:220;
      display:flex; flex-direction:column; gap:10px;
    }
    .fab{
      width:56px; height:56px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      color:#fff;
      background:var(--accent);
      box-shadow: 0 14px 30px rgba(248,92,88,.35);
      display:flex; align-items:center; justify-content:center;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .fab:hover{transform:translateY(-1px); box-shadow: 0 18px 38px rgba(248,92,88,.38)}
    .fab:focus{outline:none; box-shadow:var(--focus), 0 18px 38px rgba(248,92,88,.38)}
    .sr{position:absolute; left:-999px; width:1px; height:1px; overflow:hidden}

    /* Mobile */
    @media (max-width: 920px){
      .searchwrap{min-width: 0; flex: 1 1 100%;}
      .hamb{display:inline-flex}
      nav{display:none}
      nav.open{display:block}
      .layout{grid-template-columns: 1fr}
      .filters{position:static; top:auto}
      .modal .pane{top:4vh}
      .pdp{grid-template-columns:1fr}
    }
    @media (max-width: 520px){
      .container{padding:0 14px}
      .iconbtn{width:40px; height:40px}
      .chip{padding:7px 9px}
      .float-wa{right:12px; bottom:12px}
      .btn, .cta{width:100%}
      .sort{width:100%}
      .sort select{width:100%}
      .toolbar .left, .toolbar .right{width:100%}
      .products{padding:0 12px 12px}
      .formgrid{grid-template-columns:1fr}
      .variantrow{grid-template-columns:1fr}
    }
  </style>
</head>

<body data-page="catalog">
<a class="skip" href="#main">–ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–∞—Ç–∞–ª–æ–≥—É</a>

<header>
  <div class="container">
    <div class="topbar">
      <a class="brand" href="index.html" aria-label="JOHNGALTAZ ‚Äî –Ω–∞ –≥–ª–∞–≤–Ω—É—é">
        <img class="logo" src="images/logo.jpg" alt="–õ–æ–≥–æ—Ç–∏–ø JOHNGALTAZ" />
        <div class="brand-title">
          <b>JOHNGALTAZ</b>
          <small id="ui-subtitle">–ö–∞—Ç–∞–ª–æ–≥ ‚Ä¢ –§–∏–ª—å—Ç—Ä—ã ‚Ä¢ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</small>
        </div>
      </a>

      <div class="searchwrap" role="search">
        <div class="search" aria-label="–ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–∞–ª–æ–≥—É">
          <span aria-hidden="true">üîé</span>
          <input id="searchInput" placeholder="–ü–æ–∏—Å–∫: –Ω–æ—É—Ç–±—É–∫, RTX 4060, –º–æ–Ω–∏—Ç–æ—Ä..." autocomplete="off" />
          <button class="btn mini" id="doSearch" type="button">–ù–∞–π—Ç–∏</button>
        </div>
      </div>

      <div class="actions">
        <button class="iconbtn hamb" id="hambBtn" type="button" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é">‚ò∞</button>

        <span class="chip" title="–Ø–∑—ã–∫">
          <span aria-hidden="true">üåê</span>
          <select id="langSel" aria-label="–í—ã–±–æ—Ä —è–∑—ã–∫–∞">
            <option value="ru">RU</option>
            <option value="kz">KZ</option>
            <option value="en">EN</option>
          </select>
        </span>

        <span class="chip" title="–í–∞–ª—é—Ç–∞">
          <span aria-hidden="true">üí±</span>
          <select id="curSel" aria-label="–í—ã–±–æ—Ä –≤–∞–ª—é—Ç—ã">
            <option value="KZT">KZT</option>
            <option value="RUB">RUB</option>
            <option value="USD">USD</option>
          </select>
        </span>

        <button class="iconbtn" id="wishBtn" type="button" aria-label="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ">
          ‚ù§ <span class="badge" id="wishCount">0</span>
        </button>
        <button class="iconbtn" id="cmpBtn" type="button" aria-label="–°—Ä–∞–≤–Ω–µ–Ω–∏–µ">
          ‚â° <span class="badge" id="cmpCount">0</span>
        </button>
        <button class="iconbtn" id="cartBtn" type="button" aria-label="–ö–æ—Ä–∑–∏–Ω–∞">
          üõí <span class="badge" id="cartCount">0</span>
        </button>
      </div>
    </div>

    <nav id="nav" aria-label="–û—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è">
      <div class="navrow">
        <div class="navlinks">
          <a href="index.html" id="navHome">–ì–ª–∞–≤–Ω–∞—è</a>
          <a href="catalog.html" id="navCatalog">–ö–∞—Ç–∞–ª–æ–≥</a>
          <a href="#checkout" id="navCheckout">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</a>
        </div>
        <div class="navright">
          <button class="btn" id="openCompare" type="button">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ</button>
          <button class="cta" id="openOneClick" type="button">–ö—É–ø–∏—Ç—å –≤ 1 –∫–ª–∏–∫</button>
        </div>
      </div>
    </nav>
  </div>
</header>

<main id="main" class="container">
  <div class="pagehead">
    <div>
      <div class="crumbs" id="crumbs">–ì–ª–∞–≤–Ω–∞—è ‚Üí –ö–∞—Ç–∞–ª–æ–≥</div>
      <h1 id="pageTitle">–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</h1>
      <p id="pageDesc">–§–∏–ª—å—Ç—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç –±—ã—Å—Ç—Ä–æ, —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ 4 —Ç–æ–≤–∞—Ä–æ–≤, –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –∏ –∫–æ—Ä–∑–∏–Ω–∞. –î–ª—è –ø—Ä–µ–¥–∑–∞–∫–∞–∑–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ä–æ–∫–∏ ‚Äú~8 –¥–Ω–µ–π –¥–æ –ê–ª–º–∞—Ç—ã + –¥–æ—Å—Ç–∞–≤–∫–∞‚Äù.</p>
    </div>
    <div class="pill" id="activePill">–ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã: 0</div>
  </div>

  <div class="layout">
    <!-- Filters -->
    <aside class="card pad filters" id="filtersCard" aria-label="–§–∏–ª—å—Ç—Ä—ã –∫–∞—Ç–∞–ª–æ–≥–∞">
      <div class="fhead">
        <b>–§–∏–ª—å—Ç—Ä—ã</b>
        <button class="btn mini" type="button" id="resetBtn">–°–±—Ä–æ—Å</button>
      </div>

      <div class="group">
        <div class="gtitle">
          <b>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</b>
          <button type="button" data-toggle="cat">‚ñæ</button>
        </div>
        <div class="rows" data-box="cat">
          <div class="field">
            <label for="catSel">–í—ã–±–æ—Ä</label>
            <select id="catSel">
              <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
              <option value="laptops">–ò–≥—Ä–æ–≤—ã–µ –Ω–æ—É—Ç–±—É–∫–∏</option>
              <option value="periphery">–ü–µ—Ä–∏—Ñ–µ—Ä–∏—è</option>
              <option value="home">–ú–µ–ª–∫–æ-–±—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞</option>
              <option value="cosmo">–ö–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</option>
              <option value="medical">–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</option>
            </select>
          </div>

          <div class="field">
            <label for="subSel">–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <select id="subSel">
              <option value="">–í—Å–µ</option>
            </select>
          </div>
        </div>
      </div>

      <div class="group">
        <div class="gtitle">
          <b>–¶–µ–Ω–∞</b>
          <button type="button" data-toggle="price">‚ñæ</button>
        </div>
        <div class="rows" data-box="price">
          <div class="range2">
            <div class="field">
              <label for="minPrice">–ú–∏–Ω (KZT)</label>
              <input id="minPrice" inputmode="numeric" placeholder="0" />
            </div>
            <div class="field">
              <label for="maxPrice">–ú–∞–∫—Å (KZT)</label>
              <input id="maxPrice" inputmode="numeric" placeholder="‚àû" />
            </div>
          </div>
          <div class="rangeval" id="priceHint">–ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ —Ü–µ–Ω–µ</div>
        </div>
      </div>

      <div class="group">
        <div class="gtitle">
          <b>–ë—Ä–µ–Ω–¥</b>
          <button type="button" data-toggle="brand">‚ñæ</button>
        </div>
        <div class="rows" data-box="brand">
          <div class="field">
            <label for="brandSel">–í—ã–±–æ—Ä</label>
            <select id="brandSel">
              <option value="">–í—Å–µ</option>
            </select>
          </div>
        </div>
      </div>

      <div class="group">
        <div class="gtitle">
          <b>–ù–∞–ª–∏—á–∏–µ</b>
          <button type="button" data-toggle="stock">‚ñæ</button>
        </div>
        <div class="rows" data-box="stock">
          <div class="switch">
            <span>–¢–æ–ª—å–∫–æ ‚Äú–í –Ω–∞–ª–∏—á–∏–∏‚Äù</span>
            <input type="checkbox" id="onlyInStock" />
          </div>
          <div class="switch">
            <span>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å ‚Äú–ü—Ä–µ–¥–∑–∞–∫–∞–∑‚Äù</span>
            <input type="checkbox" id="showPreorder" checked />
          </div>
        </div>
      </div>

      <!-- Laptop-only -->
      <div class="group" id="laptopFilters" style="display:none">
        <div class="gtitle">
          <b>–ù–æ—É—Ç–±—É–∫–∏: —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</b>
          <button type="button" data-toggle="laptop">‚ñæ</button>
        </div>
        <div class="rows" data-box="laptop">
          <div class="field">
            <label for="cpuSel">CPU</label>
            <select id="cpuSel"><option value="">–õ—é–±–æ–π</option></select>
          </div>
          <div class="field">
            <label for="gpuSel">GPU</label>
            <select id="gpuSel"><option value="">–õ—é–±–æ–π</option></select>
          </div>
          <div class="field">
            <label for="ramSel">RAM</label>
            <select id="ramSel"><option value="">–õ—é–±–∞—è</option></select>
          </div>
          <div class="field">
            <label for="ssdSel">SSD</label>
            <select id="ssdSel"><option value="">–õ—é–±–æ–π</option></select>
          </div>
          <div class="field">
            <label for="inchSel">–≠–∫—Ä–∞–Ω (–¥—é–π–º—ã)</label>
            <select id="inchSel"><option value="">–õ—é–±–æ–π</option></select>
          </div>
          <div class="field">
            <label for="hzSel">–ß–∞—Å—Ç–æ—Ç–∞ (Hz)</label>
            <select id="hzSel"><option value="">–õ—é–±–∞—è</option></select>
          </div>
          <div class="field">
            <label for="osSel">–û–°</label>
            <select id="osSel"><option value="">–õ—é–±–∞—è</option></select>
          </div>
          <div class="field">
            <label for="panelSel">–ú–∞—Ç—Ä–∏—Ü–∞</label>
            <select id="panelSel"><option value="">–õ—é–±–∞—è</option></select>
          </div>
        </div>
      </div>

      <div class="group">
        <div class="gtitle">
          <b>–ë—ã—Å—Ç—Ä—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</b>
          <button type="button" data-toggle="quick">‚ñæ</button>
        </div>
        <div class="tagrow" data-box="quick">
          <span class="tag" data-qcat="laptops">–ò–≥—Ä–æ–≤—ã–µ –Ω–æ—É—Ç–±—É–∫–∏</span>
          <span class="tag" data-qcat="periphery">–ü–µ—Ä–∏—Ñ–µ—Ä–∏—è</span>
          <span class="tag" data-qcat="home">–ë—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞</span>
          <span class="tag" data-qcat="cosmo">–ö–æ—Å–º–æ</span>
          <span class="tag" data-qcat="medical">–ú–µ–¥</span>
          <span class="tag" data-qreset="1">–í—Å–µ</span>
        </div>
      </div>

      <div class="group">
        <div class="rows">
          <button class="cta" type="button" id="applyBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          <div class="rangeval" id="urlHint">–ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ URL</div>
        </div>
      </div>
    </aside>

    <!-- Results -->
    <section class="card" aria-label="–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤">
      <div class="toolbar">
        <div class="left">
          <span class="count" id="countText">–ù–∞–π–¥–µ–Ω–æ: 0</span>
          <span class="pill" id="queryPill">–ó–∞–ø—Ä–æ—Å: ‚Äî</span>
        </div>
        <div class="right">
          <div class="sort">
            <span class="count">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</span>
            <select id="sortSel" aria-label="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞">
              <option value="pop">–ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å</option>
              <option value="new">–ù–æ–≤–∏–∑–Ω–∞</option>
              <option value="price_asc">–¶–µ–Ω–∞: –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
              <option value="price_desc">–¶–µ–Ω–∞: –ø–æ —É–±—ã–≤–∞–Ω–∏—é</option>
            </select>
          </div>
          <button class="btn mini" type="button" id="openFiltersMobile">–§–∏–ª—å—Ç—Ä—ã</button>
        </div>
      </div>

      <div class="products" id="products"></div>
    </section>
  </div>

  <!-- Checkout -->
  <section id="checkout" class="checkoutWrap">
    <div class="checkoutHead">
      <div>
        <h2>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ / –∑–∞—è–≤–∫–∏</h2>
        <p>–ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞ 1‚Äì2 –º–∏–Ω—É—Ç—ã. –í —Ç–µ—Å—Ç–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ –∑–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ WhatsApp –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.</p>
      </div>
      <div class="pill" id="cartMini">–í –∫–æ—Ä–∑–∏–Ω–µ: 0</div>
    </div>

    <div class="card pad" style="margin-top:12px">
      <form id="checkoutForm">
        <div class="formgrid">
          <div class="field">
            <label for="cName">–§–ò–û</label>
            <input id="cName" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" />
          </div>
          <div class="field">
            <label for="cPhone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input id="cPhone" required placeholder="+7 ..." />
          </div>
          <div class="field">
            <label for="cCity">–ì–æ—Ä–æ–¥</label>
            <input id="cCity" required placeholder="–ê–ª–º–∞—Ç—ã / –ê—Å—Ç–∞–Ω–∞ / ..." />
          </div>
          <div class="field">
            <label for="cAddr">–ê–¥—Ä–µ—Å</label>
            <input id="cAddr" required placeholder="–£–ª–∏—Ü–∞, –¥–æ–º, –∫–≤–∞—Ä—Ç–∏—Ä–∞" />
          </div>
          <div class="field">
            <label for="cShip">–°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏</label>
            <select id="cShip" required>
              <option value="curier">–ö—É—Ä—å–µ—Ä</option>
              <option value="pickup">–°–∞–º–æ–≤—ã–≤–æ–∑</option>
              <option value="post">–ö–∞–∑–ø–æ—á—Ç–∞ / –¥–æ—Å—Ç–∞–≤–∫–∞</option>
              <option value="sdek">–°–î–≠–ö</option>
              <option value="boxberry">Boxberry</option>
            </select>
          </div>
          <div class="field">
            <label for="cPay">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</label>
            <select id="cPay" required>
              <option value="kaspi">Kaspi</option>
              <option value="card">–ö–∞—Ä—Ç–∞</option>
              <option value="transfer">–ü–µ—Ä–µ–≤–æ–¥</option>
              <option value="online">–û–Ω–ª–∞–π–Ω-—ç–∫–≤–∞–π—Ä–∏–Ω–≥ (–∫–æ–≥–¥–∞ –±—É–¥–µ—Ç)</option>
            </select>
          </div>
        </div>

        <div class="field" style="margin-top:10px">
          <label for="cComment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <textarea id="cComment" rows="3" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏, —É—Ç–æ—á–Ω–µ–Ω–∏—è –ø–æ –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–∏..."></textarea>
        </div>

        <div class="b2bBox">
          <div class="switch" style="margin:0">
            <span><b>–Æ—Ä. –ª–∏—Ü–æ</b> (B2B)</span>
            <input type="checkbox" id="isB2B" />
          </div>

          <div id="b2bFields" style="display:none">
            <div class="formgrid">
              <div class="field">
                <label for="bCompany">–ö–æ–º–ø–∞–Ω–∏—è</label>
                <input id="bCompany" placeholder="–¢–û–û ..." />
              </div>
              <div class="field">
                <label for="bBin">–ë–ò–ù/–ò–ù–ù</label>
                <input id="bBin" placeholder="..." />
              </div>
              <div class="field">
                <label for="bAddr">–Æ—Ä. –∞–¥—Ä–µ—Å</label>
                <input id="bAddr" placeholder="..." />
              </div>
              <div class="field">
                <label for="bEmail">Email –¥–ª—è —Å—á—ë—Ç–∞</label>
                <input id="bEmail" type="email" placeholder="..." />
              </div>
            </div>

            <div class="file" style="margin-top:10px">
              <div>
                <b style="font-size:13px">–†–µ–∫–≤–∏–∑–∏—Ç—ã —Ñ–∞–π–ª–æ–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</b>
                <div class="help">–ü–æ–¥—Å–∫–∞–∑–∫–∞</div>
              </div>
              <input id="bFile" type="file" />
            </div>
          </div>
        </div>

        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
          <button class="cta" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É/–∑–∞–∫–∞–∑ –≤ WhatsApp</button>
          <button class="btn" type="button" id="openCartFromCheckout">–û—Ç–∫—Ä—ã—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>
        </div>
      </form>
    </div>
  </section>
</main>

<!-- Overlay + Drawer (cart/wish/compare) -->
<div class="overlay" id="overlay" tabindex="-1" aria-hidden="true"></div>

<aside class="drawer" id="drawer" aria-label="–ü–∞–Ω–µ–ª—å">
  <header class="row">
    <h3 id="drawerTitle">–ü–∞–Ω–µ–ª—å</h3>
    <button class="close" id="drawerClose" type="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
  </header>
  <div class="content" id="drawerContent"></div>
  <div class="totals" id="drawerTotals" style="display:none"></div>
</aside>

<!-- Product modal -->
<div class="modal" id="modal" aria-hidden="true">
  <div class="overlay show" id="modalOverlay" style="display:block"></div>
  <div class="pane" role="dialog" aria-modal="true" aria-label="–ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞">
    <div class="mhead">
      <b id="mTitle">–¢–æ–≤–∞—Ä</b>
      <button class="close" id="mClose" type="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
    </div>
    <div class="mbody" id="mBody"></div>
  </div>
</div>

<!-- Floating WA -->
<div class="float-wa" aria-label="–ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏">
  <button class="fab" id="fabWA" type="button" aria-label="WhatsApp">
    <span aria-hidden="true">üí¨</span>
    <span class="sr">WhatsApp</span>
  </button>
</div>

<script>
/* ===========================
   Catalog mini-app (2 files)
   =========================== */

const ADMIN_WA = "+77470436747"; // –∏–∑ –¢–ó
const STORE_KEY = "jg_store_v1";

/* I18N (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ –¥–ª—è UI-—è–¥—Ä–∞) */
const I18N = {
  ru: {
    subtitle: "–ö–∞—Ç–∞–ª–æ–≥ ‚Ä¢ –§–∏–ª—å—Ç—Ä—ã ‚Ä¢ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ",
    empty: "–ü–æ–∫–∞ –ø—É—Å—Ç–æ",
    cart: "–ö–æ—Ä–∑–∏–Ω–∞",
    wishlist: "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ",
    compare: "–°—Ä–∞–≤–Ω–µ–Ω–∏–µ",
    checkout: "–û—Ñ–æ—Ä–º–∏—Ç—å (–≤ WhatsApp)",
    in: "–í –Ω–∞–ª–∏—á–∏–∏",
    pre: "–ü–æ–¥ –∑–∞–∫–∞–∑ / –ü—Ä–µ–¥–∑–∞–∫–∞–∑",
    preorderLine: "–ü–æ—Å—Ç–∞–≤–∫–∞ –¥–æ –ê–ª–º–∞—Ç—ã ~ 8 –¥–Ω–µ–π + –¥–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –≥–æ—Ä–æ–¥—É/–≤ —Ä–µ–≥–∏–æ–Ω—ã",
    ask: "–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å",
    quote: "–ó–∞–ø—Ä–æ—Å –ö–ü",
    buy: "–í –∫–æ—Ä–∑–∏–Ω—É",
    buyNow: "–ö—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å",
    oneClick: "–ö—É–ø–∏—Ç—å –≤ 1 –∫–ª–∏–∫",
    open: "–û—Ç–∫—Ä—ã—Ç—å",
    remove: "–£–±—Ä–∞—Ç—å",
    del: "–£–¥–∞–ª–∏—Ç—å",
    total: "–ò—Ç–æ–≥–æ",
    goCheckout: "–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é",
    diff: "–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–ª–∏—á–∏—è",
  },
  kz: {
    subtitle: "–ö–∞—Ç–∞–ª–æ–≥ ‚Ä¢ –°“Ø–∑–≥—ñ–ª–µ—Ä ‚Ä¢ –†”ô—Å—ñ–º–¥–µ—É",
    empty: "”ò–∑—ñ—Ä–≥–µ –±–æ—Å",
    cart: "–°–µ–±–µ—Ç",
    wishlist: "–¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä",
    compare: "–°–∞–ª—ã—Å—Ç—ã—Ä—É",
    checkout: "WhatsApp-“õ–∞ –∂—ñ–±–µ—Ä—É",
    in: "–ë–∞—Ä",
    pre: "–ê–ª–¥—ã–Ω –∞–ª–∞ —Ç–∞–ø—Å—ã—Ä—ã—Å",
    preorderLine: "–ê–ª–º–∞—Ç—ã“ì–∞ ~ 8 –∫“Ø–Ω + “õ–∞–ª–∞/–∞–π–º–∞“õ –∂–µ—Ç–∫—ñ–∑—É—ñ",
    ask: "–°“±—Ä–∞“õ “õ–æ—é",
    quote: "–ö–ü —Å“±—Ä–∞—É",
    buy: "–°–µ–±–µ—Ç–∫–µ",
    buyNow: "“ö–∞–∑—ñ—Ä —Å–∞—Ç—ã–ø –∞–ª—É",
    oneClick: "1 —à–µ—Ä—Ç—É",
    open: "–ê—à—É",
    remove: "–ê–ª—É",
    del: "”®—à—ñ—Ä—É",
    total: "–ë–∞—Ä–ª—ã“ì—ã",
    goCheckout: "–†”ô—Å—ñ–º–¥–µ—É–≥–µ ”©—Ç—É",
    diff: "–ê–π—ã—Ä–º–∞—à—ã–ª—ã“õ",
  },
  en: {
    subtitle: "Catalog ‚Ä¢ Filters ‚Ä¢ Checkout",
    empty: "It‚Äôs empty for now",
    cart: "Cart",
    wishlist: "Wishlist",
    compare: "Compare",
    checkout: "Send via WhatsApp",
    in: "In stock",
    pre: "Preorder",
    preorderLine: "~8 days to Almaty + local/regional delivery",
    ask: "Ask",
    quote: "Request quote",
    buy: "Add to cart",
    buyNow: "Buy now",
    oneClick: "1-click",
    open: "Open",
    remove: "Remove",
    del: "Delete",
    total: "Total",
    goCheckout: "Go to checkout",
    diff: "Highlight diffs",
  }
};

const FX = { // —Ç–µ—Å—Ç–æ–≤—ã–µ –∫—É—Ä—Å—ã
  KZT: 1,
  RUB: 0.20,
  USD: 0.0022
};

function loadState(){
  const raw = localStorage.getItem(STORE_KEY);
  return raw ? JSON.parse(raw) : { lang:"ru", cur:"KZT", cart:[], wish:[], cmp:[] };
}
function saveState(s){ localStorage.setItem(STORE_KEY, JSON.stringify(s)); }
function fmtMoney(kzt, cur){
  const rate = FX[cur] ?? 1;
  const val = kzt * rate;
  const opt = { maximumFractionDigits: cur==="KZT" ? 0 : 2 };
  return new Intl.NumberFormat(undefined, opt).format(val) + " " + cur;
}
function waLink(text){
  const msg = encodeURIComponent(text);
  const phone = ADMIN_WA.replace(/\D/g,"");
  return `https://wa.me/${phone}?text=${msg}`;
}
function openWA(text){
  window.open(waLink(text), "_blank", "noopener,noreferrer");
}

const state = loadState();

/* ===========================
   Data (50 —Ç–æ–≤–∞—Ä–æ–≤)
   - –∫–∞—Ä—Ç–∏–Ω–∫–∏: images/tovar1.jpg ... tovar50.jpg
   =========================== */

function mkLaptop(i, brand, cpu, gpu, ram, ssd, inch, hz, panel, os, price, oldPrice, stock){
  return {
    id: i,
    sku: `LAP-${String(i).padStart(3,"0")}`,
    name: `${brand} Gaming ${inch}" (${cpu} / ${gpu})`,
    cat: "laptops",
    sub: "gaming",
    brand,
    priceKZT: price,
    oldPriceKZT: oldPrice || null,
    stock, // "in" | "pre"
    leadDays: stock==="pre" ? 8 : 0,
    img: `tovar${i}.jpg`,
    popularity: 100 - i,
    created: 1000 - i,
    flags: { quoteOnly:false },
    specs: { cpu, gpu, ram, ssd, inch, hz, panel, os, weight: (2.1 + (i%7)*0.05).toFixed(2) + " kg", backlight: (i%2===0) ? "–î–∞" : "–û–ø—Ü." }
  };
}

function mkSimple(i, cat, sub, brand, name, price, oldPrice, stock, quoteOnly=false){
  return {
    id: i,
    sku: `${cat.toUpperCase().slice(0,3)}-${String(i).padStart(3,"0")}`,
    name: name,
    cat, sub,
    brand,
    priceKZT: price,
    oldPriceKZT: oldPrice || null,
    stock,
    leadDays: stock==="pre" ? 8 : 0,
    img: `tovar${i}.jpg`,
    popularity: 80 - (i%30),
    created: 900 - i,
    flags: { quoteOnly: !!quoteOnly },
    specs: {}
  };
}

/* –°–æ–±–∏—Ä–∞–µ–º —Ä–æ–≤–Ω–æ 50 */
const PRODUCTS = [];
// 1..20 laptops
const brandsL = ["THUNDEROBOT","ASUS","Acer","MSI","Lenovo"];
const cpus = ["Intel i5-13420H","Intel i7-13620H","Ryzen 5 7640HS","Ryzen 7 7840HS","Intel i9-13900H"];
const gpus = ["RTX 4050","RTX 4060","RTX 4070","RTX 4080","RTX 3050"];
const rams = ["16GB","32GB","64GB"];
const ssds = ["512GB NVMe","1TB NVMe","2TB NVMe"];
const inches = ["15.6","16","17.3"];
const hzs = ["144","165","240"];
const panels = ["IPS","VA","Mini-LED"];
const oss = ["Windows 11","–ë–µ–∑ –û–°","Linux"];

for(let i=1;i<=20;i++){
  const brand = brandsL[i%brandsL.length];
  const cpu = cpus[i%cpus.length];
  const gpu = gpus[i%gpus.length];
  const ram = rams[i%rams.length];
  const ssd = ssds[i%ssds.length];
  const inch = inches[i%inches.length];
  const hz = hzs[i%hzs.length];
  const panel = panels[i%panels.length];
  const os = oss[i%oss.length];
  const price = 420000 + i*28000;
  const oldP = (i%4===0) ? Math.round(price*1.12) : null;
  const stock = (i%3===0) ? "pre" : "in";
  PRODUCTS.push(mkLaptop(i, brand, cpu, gpu, ram, ssd, inch, hz, panel, os, price, oldP, stock));
}

// 21..35 periphery + home
const perBrands = ["Logitech","Razer","HyperX","SteelSeries","AOC"];
const homeBrands = ["Xiaomi","Philips","Tefal","Samsung","LG"];

const perSubs = [
  ["mice","–ú—ã—à—å –∏–≥—Ä–æ–≤–∞—è"],
  ["keyboards","–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∞—è"],
  ["headsets","–ì–∞—Ä–Ω–∏—Ç—É—Ä–∞"],
  ["monitors","–ú–æ–Ω–∏—Ç–æ—Ä"],
  ["pads","–ö–æ–≤—Ä–∏–∫"]
];

for(let i=21;i<=30;i++){
  const b = perBrands[i%perBrands.length];
  const [sub, base] = perSubs[i%perSubs.length];
  const name = `${b} ${base} Pro ${i}`;
  const price = 12000 + (i-20)*9000;
  const oldP = (i%5===0) ? Math.round(price*1.18) : null;
  const stock = (i%4===0) ? "pre" : "in";
  PRODUCTS.push(mkSimple(i, "periphery", sub, b, name, price, oldP, stock, false));
}

const homeSubs = [
  ["kitchen","–¢–µ—Ö–Ω–∏–∫–∞ –¥–ª—è –∫—É—Ö–Ω–∏"],
  ["care","–£—Ö–æ–¥/–≥–∏–≥–∏–µ–Ω–∞"],
  ["climate","–ö–ª–∏–º–∞—Ç"],
  ["clean","–£–±–æ—Ä–∫–∞"],
  ["iron","–£—Ç—é–≥/–ø–∞—Ä"]
];

for(let i=31;i<=35;i++){
  const b = homeBrands[i%homeBrands.length];
  const [sub, base] = homeSubs[i%homeSubs.length];
  const name = `${b} ${base} Model ${i}`;
  const price = 25000 + (i-30)*25000;
  const oldP = (i%2===0) ? Math.round(price*1.15) : null;
  const stock = (i%3===0) ? "pre" : "in";
  PRODUCTS.push(mkSimple(i, "home", sub, b, name, price, oldP, stock, false));
}

// 36..50 cosmo + medical (—á–∞—Å—Ç—å quoteOnly)
const cosBrands = ["LumiPro","DermaLine","BeautyTech","SkinLab"];
const medBrands = ["MedCare","BioPulse","ClinicPro","HealthLine"];

const cosSubs = [
  ["laser","–õ–∞–∑–µ—Ä/—ç–ø–∏–ª—è—Ü–∏—è"],
  ["rf","RF-–ª–∏—Ñ—Ç–∏–Ω–≥"],
  ["hydra","–ì–∏–¥—Ä–æ–ø–∏–ª–∏–Ω–≥"],
  ["massage","–ú–∞—Å—Å–∞–∂/–≤–∞–∫—É—É–º"]
];
const medSubs = [
  ["diagnostics","–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞"],
  ["therapy","–¢–µ—Ä–∞–ø–∏—è"],
  ["steril","–°—Ç–µ—Ä–∏–ª–∏–∑–∞—Ü–∏—è"],
  ["consum","–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏/–∞–∫—Å–µ—Å—Å."]
];

for(let i=36;i<=42;i++){
  const b = cosBrands[i%cosBrands.length];
  const [sub, base] = cosSubs[i%cosSubs.length];
  const quoteOnly = (i%2===0); // —á–∞—Å—Ç—å ‚Äî —Ç–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å –ö–ü
  const name = `${b} ${base} System ${i}`;
  const price = 220000 + (i-35)*65000;
  const oldP = null;
  const stock = "pre";
  PRODUCTS.push(mkSimple(i, "cosmo", sub, b, name, price, oldP, stock, quoteOnly));
}

for(let i=43;i<=50;i++){
  const b = medBrands[i%medBrands.length];
  const [sub, base] = medSubs[i%medSubs.length];
  const quoteOnly = (i%3!==0); // —á–∞—â–µ —á–µ—Ä–µ–∑ –ö–ü
  const name = `${b} ${base} Unit ${i}`;
  const price = 180000 + (i-42)*80000;
  const oldP = (i%4===0) ? Math.round(price*1.10) : null;
  const stock = (i%2===0) ? "pre" : "in";
  PRODUCTS.push(mkSimple(i, "medical", sub, b, name, price, oldP, stock, quoteOnly));
}

/* –î–æ–±–∞–≤–∏–º ‚Äú—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ‚Äù —Å–ø–µ–∫–∏ –¥–ª—è non-laptops */
function enrichSimpleSpecs(p){
  if(p.cat==="periphery"){
    p.specs = {
      type: p.sub,
      connection: (p.id%2===0) ? "–ë–µ—Å–ø—Ä–æ–≤–æ–¥–Ω–æ–µ" : "–ü—Ä–æ–≤–æ–¥–Ω–æ–µ",
      warranty: "12 –º–µ—Å",
      color: (p.id%3===0) ? "Black" : "Black/Red"
    };
  }
  if(p.cat==="home"){
    p.specs = {
      type: p.sub,
      power: (800 + (p.id%6)*150) + " W",
      warranty: "12 –º–µ—Å",
      weight: (1.2 + (p.id%5)*0.2).toFixed(1) + " kg"
    };
  }
  if(p.cat==="cosmo"){
    p.specs = {
      type: p.sub,
      mode: "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π",
      docs: "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã/–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (–ø–æ –∑–∞–ø—Ä–æ—Å—É)",
      warranty: "12 –º–µ—Å"
    };
    p.warning = "–í–∞–∂–Ω–æ: –∏–º–µ—é—Ç—Å—è –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏—è/—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è. –£—Ç–æ—á–Ω—è–π—Ç–µ —É –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø–µ—Ä–µ–¥ –ø–æ–∫—É–ø–∫–æ–π.";
    p.docs = ["–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è (–ø—Ä–∏–º–µ—Ä)", "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (–ø—Ä–∏–º–µ—Ä)"];
  }
  if(p.cat==="medical"){
    p.specs = {
      type: p.sub,
      docs: "–†–µ–≥. —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ/—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)",
      warranty: "12 –º–µ—Å",
      service: "–°–µ—Ä–≤–∏—Å/–æ–±—É—á–µ–Ω–∏–µ (–æ–ø—Ü.)"
    };
    p.warning = "–í–∞–∂–Ω–æ: –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ –∏ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è. –ó–∞–ø—Ä–æ—Å–∏—Ç–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é.";
    p.docs = ["–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (–ø—Ä–∏–º–µ—Ä)", "–ü–∞—Å–ø–æ—Ä—Ç –∏–∑–¥–µ–ª–∏—è (–ø—Ä–∏–º–µ—Ä)"];
  }
  return p;
}
PRODUCTS.forEach(enrichSimpleSpecs);

/* ===========================
   Helpers / URL state
   =========================== */

function qsParse(){
  const u = new URL(location.href);
  const q = {};
  u.searchParams.forEach((v,k)=> q[k]=v);
  return q;
}
function qsSet(params){
  const u = new URL(location.href);
  Object.keys(params).forEach(k=>{
    const v = params[k];
    if(v===undefined || v===null || v==="") u.searchParams.delete(k);
    else u.searchParams.set(k, String(v));
  });
  history.replaceState({}, "", u.toString());
}
function uniq(arr){ return Array.from(new Set(arr)).filter(Boolean); }

function setCounts(){
  document.getElementById("wishCount").textContent = state.wish.length;
  document.getElementById("cmpCount").textContent = state.cmp.length;
  document.getElementById("cartCount").textContent = state.cart.reduce((a,i)=>a+i.qty,0);
  document.getElementById("cartMini").textContent = "–í –∫–æ—Ä–∑–∏–Ω–µ: " + state.cart.reduce((a,i)=>a+i.qty,0);
}

function applyI18N(){
  const t = I18N[state.lang] || I18N.ru;
  document.getElementById("ui-subtitle").textContent = t.subtitle;
}

/* ===========================
   Drawer UI (cart/wish/compare)
   =========================== */

function drawerOpen(title, html, totalsHtml=null){
  const overlay = document.getElementById("overlay");
  const drawer = document.getElementById("drawer");
  document.getElementById("drawerTitle").textContent = title;
  document.getElementById("drawerContent").innerHTML = html;

  const totals = document.getElementById("drawerTotals");
  if(totalsHtml){
    totals.style.display="block";
    totals.innerHTML = totalsHtml;
  } else {
    totals.style.display="none";
    totals.innerHTML = "";
  }

  overlay.classList.add("show");
  drawer.classList.add("show");
  overlay.setAttribute("aria-hidden","false");
  overlay.focus();
}
function drawerClose(){
  document.getElementById("overlay").classList.remove("show");
  document.getElementById("drawer").classList.remove("show");
  document.getElementById("overlay").setAttribute("aria-hidden","true");
}
document.getElementById("drawerClose").addEventListener("click", drawerClose);
document.getElementById("overlay").addEventListener("click", drawerClose);

function renderCart(){
  const t = I18N[state.lang] || I18N.ru;
  if(!state.cart.length){
    drawerOpen(t.cart, `<p class="muted">${t.empty}</p>`);
    return;
  }

  const rows = state.cart.map(it => `
    <div class="item">
      <div>
        <img class="thumb" src="images/${it.img || "tovar1.jpg"}" alt="">
      </div>
      <div>
        <b>${it.name || it.sku}</b>
        <small>${it.variantName ? it.variantName : ""}</small>
        <small class="muted">${it.stock || ""}</small>
        <div class="qty">
          <button type="button" data-act="dec" data-sku="${it.sku}" data-vid="${it.vid}">‚àí</button>
          <input value="${it.qty}" inputmode="numeric" data-act="qty" data-sku="${it.sku}" data-vid="${it.vid}">
          <button type="button" data-act="inc" data-sku="${it.sku}" data-vid="${it.vid}">+</button>
          <button class="btn mini" type="button" data-act="rm" data-sku="${it.sku}" data-vid="${it.vid}">${t.del}</button>
        </div>
      </div>
    </div>
  `).join("");

  const totalKZT = state.cart.reduce((sum,it)=>sum + (it.priceKZT||0)*it.qty, 0);

  drawerOpen(
    t.cart,
    rows,
    `
      <div class="row" style="margin-bottom:10px">
        <div class="muted">${t.total}</div>
        <div><b>${fmtMoney(totalKZT, state.cur)}</b></div>
      </div>
      <button class="cta" id="goCheckout" type="button">${t.goCheckout}</button>
    `
  );

  document.getElementById("drawerContent").addEventListener("click", (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    const act = btn.dataset.act;
    if(!act) return;
    const sku = btn.dataset.sku;
    const vid = btn.dataset.vid;
    const idx = state.cart.findIndex(x=>x.sku===sku && String(x.vid)===String(vid));
    if(idx<0) return;
    if(act==="inc") state.cart[idx].qty += 1;
    if(act==="dec") state.cart[idx].qty = Math.max(1, state.cart[idx].qty - 1);
    if(act==="rm") state.cart.splice(idx,1);
    saveState(state); setCounts(); renderCart();
  }, { once:true });

  document.getElementById("goCheckout").addEventListener("click", ()=>{
    drawerClose();
    document.getElementById("checkout").scrollIntoView({behavior:"smooth"});
  });
}

function renderWish(){
  const t = I18N[state.lang] || I18N.ru;
  if(!state.wish.length){
    drawerOpen(t.wishlist, `<p class="muted">${t.empty}</p>`);
    return;
  }
  const html = state.wish.map(sku=>{
    const p = PRODUCTS.find(x=>x.sku===sku);
    return `
      <div class="item">
        <img class="thumb" src="images/${p?.img || "tovar1.jpg"}" alt="">
        <div>
          <b>${p?.name || sku}</b>
          <small class="muted">${p ? fmtMoney(p.priceKZT, state.cur) : ""}</small>
          <div class="qty">
            <button class="btn mini" type="button" data-open="${sku}">${t.open}</button>
            <button class="btn mini" type="button" data-rm="${sku}">${t.remove}</button>
          </div>
        </div>
      </div>
    `;
  }).join("");
  drawerOpen(t.wishlist, html);

  document.getElementById("drawerContent").addEventListener("click",(e)=>{
    const bOpen = e.target.closest("button[data-open]");
    const bRm = e.target.closest("button[data-rm]");
    if(bOpen){
      const sku = bOpen.dataset.open;
      drawerClose();
      openProduct(sku);
    }
    if(bRm){
      const sku = bRm.dataset.rm;
      const i = state.wish.indexOf(sku);
      if(i>=0) state.wish.splice(i,1);
      saveState(state); setCounts(); renderWish();
    }
  }, { once:true });
}

function renderCompare(){
  const t = I18N[state.lang] || I18N.ru;
  if(!state.cmp.length){
    drawerOpen(t.compare, `<p class="muted">${t.empty}</p>`);
    return;
  }
  const items = state.cmp.map(sku=>PRODUCTS.find(x=>x.sku===sku)).filter(Boolean).slice(0,4);

  const allKeys = uniq(items.flatMap(p=>{
    const base = (p.cat==="laptops")
      ? ["brand","cpu","gpu","ram","ssd","inch","hz","panel","os","weight","backlight"]
      : Object.keys(p.specs || {});
    return base;
  }));

  function val(p,k){
    if(p.cat==="laptops"){
      const s = p.specs || {};
      const map = { brand:p.brand, cpu:s.cpu, gpu:s.gpu, ram:s.ram, ssd:s.ssd, inch:s.inch, hz:s.hz, panel:s.panel, os:s.os, weight:s.weight, backlight:s.backlight };
      return map[k] ?? "‚Äî";
    }
    return (p.specs && p.specs[k]) ? p.specs[k] : "‚Äî";
  }

  const head = `
    <div class="row" style="margin-bottom:10px">
      <div class="muted">–¢–æ–≤–∞—Ä–æ–≤: ${items.length}/4</div>
      <button class="btn mini" type="button" id="cmpDiff">${t.diff}</button>
    </div>
  `;

  const cols = items.map(p=>`
    <div class="card pad" style="box-shadow:none; border-radius:16px; border:1px solid rgba(214,214,214,.75)">
      <b style="font-size:13px">${p.name}</b>
      <small class="muted">${fmtMoney(p.priceKZT, state.cur)}</small>
      <div class="qty" style="margin-top:8px">
        <button class="btn mini" type="button" data-open="${p.sku}">${t.open}</button>
        <button class="btn mini" type="button" data-rm="${p.sku}">${t.remove}</button>
      </div>
    </div>
  `).join("");

  const table = `
    <div style="display:grid; grid-template-columns: repeat(${items.length}, minmax(0,1fr)); gap:10px; margin-bottom:12px">
      ${cols}
    </div>
    <div class="card pad" style="box-shadow:none; border-radius:16px; border:1px solid rgba(214,214,214,.75)">
      <table class="tbl" id="cmpTbl">
        ${allKeys.map(k=>`
          <tr data-k="${k}">
            <td>${k.toUpperCase()}</td>
            <td style="display:none"></td>
          </tr>
        `).join("")}
      </table>
      <div style="display:grid; grid-template-columns: repeat(${items.length}, minmax(0,1fr)); gap:10px; margin-top:10px" id="cmpGrid">
        ${items.map(p=>`
          <div class="box" style="border-radius:16px">
            ${allKeys.map(k=>`<div style="display:flex; justify-content:space-between; gap:10px; padding:7px 0; border-bottom:1px dashed rgba(214,214,214,.8)">
              <span class="muted" style="font-size:12px">${k.toUpperCase()}</span>
              <b style="font-size:12px; text-align:right">${val(p,k)}</b>
            </div>`).join("")}
          </div>
        `).join("")}
      </div>
    </div>
  `;

  drawerOpen(t.compare, head + table);

  const dc = document.getElementById("drawerContent");
  dc.addEventListener("click",(e)=>{
    const bOpen = e.target.closest("button[data-open]");
    const bRm = e.target.closest("button[data-rm]");
    if(bOpen){
      const sku = bOpen.dataset.open;
      drawerClose();
      openProduct(sku);
    }
    if(bRm){
      const sku = bRm.dataset.rm;
      const i = state.cmp.indexOf(sku);
      if(i>=0) state.cmp.splice(i,1);
      saveState(state); setCounts(); renderCompare();
    }
  }, { once:true });

  document.getElementById("cmpDiff").addEventListener("click", ()=>{
    // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –æ—Ç–ª–∏—á–∏–π: —Å–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏, –≥–¥–µ –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ
    const boxes = Array.from(document.querySelectorAll("#cmpGrid .box"));
    const rowsCount = allKeys.length;
    for(let r=0; r<rowsCount; r++){
      const k = allKeys[r];
      const vals = items.map(p=>String(val(p,k)));
      const allSame = vals.every(v=>v===vals[0]);
      if(allSame){
        boxes.forEach(b=>{
          const row = b.children[r];
          if(row) row.style.display = "none";
        });
      } else {
        boxes.forEach(b=>{
          const row = b.children[r];
          if(row) row.style.display = "";
        });
      }
    }
  });
}

/* ===========================
   Modal (PDP + variants)
   =========================== */

function modalOpen(title, html){
  const m = document.getElementById("modal");
  document.getElementById("mTitle").textContent = title;
  document.getElementById("mBody").innerHTML = html;
  m.classList.add("show");
  m.setAttribute("aria-hidden","false");
}
function modalClose(){
  const m = document.getElementById("modal");
  m.classList.remove("show");
  m.setAttribute("aria-hidden","true");
}
document.getElementById("mClose").addEventListener("click", modalClose);
document.getElementById("modalOverlay").addEventListener("click", modalClose);

function skuInList(list, sku){ return list.includes(sku); }

function addToWish(sku){
  const i = state.wish.indexOf(sku);
  if(i>=0) state.wish.splice(i,1);
  else state.wish.push(sku);
  saveState(state); setCounts(); render();
}
function addToCmp(sku){
  const i = state.cmp.indexOf(sku);
  if(i>=0) state.cmp.splice(i,1);
  else {
    if(state.cmp.length>=4){ alert("–ú–æ–∂–Ω–æ —Å—Ä–∞–≤–Ω–∏—Ç—å –¥–æ 4 —Ç–æ–≤–∞—Ä–æ–≤."); return; }
    state.cmp.push(sku);
  }
  saveState(state); setCounts(); render();
}

function addToCart(item, qty=1, vid="base", variantName=""){
  const existing = state.cart.find(x=>x.sku===item.sku && String(x.vid)===String(vid));
  const stockLabel = (item.stock==="in") ? (I18N[state.lang].in) : (I18N[state.lang].pre);
  if(existing) existing.qty += qty;
  else {
    state.cart.push({
      sku: item.sku,
      name: item.name,
      priceKZT: item.priceKZT,
      img: item.img,
      qty,
      vid,
      variantName,
      stock: stockLabel + (item.stock==="pre" ? " ‚Ä¢ ~8 –¥–Ω–µ–π" : "")
    });
  }
  saveState(state); setCounts();
}

function openProduct(sku){
  const t = I18N[state.lang] || I18N.ru;
  const p = PRODUCTS.find(x=>x.sku===sku);
  if(!p){ alert("–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"); return; }

  // variants (–¥–ª—è –Ω–æ—É—Ç–±—É–∫–æ–≤ –∏–º–∏—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥–∏: RAM/SSD)
  const variants = [];
  if(p.cat==="laptops"){
    const baseRam = p.specs.ram;
    const baseSsd = p.specs.ssd;
    const altRam = (baseRam==="16GB") ? "32GB" : "16GB";
    const altSsd = (baseSsd.includes("512")) ? "1TB NVMe" : "512GB NVMe";
    variants.push({ id:"v1", ram:baseRam, ssd:baseSsd, priceKZT:p.priceKZT, stock:p.stock });
    variants.push({ id:"v2", ram:altRam, ssd:baseSsd, priceKZT:Math.round(p.priceKZT*1.08), stock:(p.id%2===0)?"pre":"in" });
    variants.push({ id:"v3", ram:baseRam, ssd:altSsd, priceKZT:Math.round(p.priceKZT*1.06), stock:"pre" });
  } else {
    variants.push({ id:"base", priceKZT:p.priceKZT, stock:p.stock });
  }

  const stockChip = (p.stock==="in")
    ? `<span class="chip2 ok">‚úÖ ${t.in}</span>`
    : `<span class="chip2 warn">‚è≥ ${t.pre}</span>`;

  const preorderLine = (p.stock==="pre")
    ? `<div class="preorderline">${t.preorderLine}</div>`
    : "";

  const specsRows = (p.cat==="laptops")
    ? [
      ["–ë—Ä–µ–Ω–¥", p.brand],
      ["CPU", p.specs.cpu],
      ["GPU", p.specs.gpu],
      ["RAM", p.specs.ram],
      ["SSD", p.specs.ssd],
      ["–≠–∫—Ä–∞–Ω", `${p.specs.inch}" ‚Ä¢ ${p.specs.hz}Hz ‚Ä¢ ${p.specs.panel}`],
      ["–û–°", p.specs.os],
      ["–í–µ—Å", p.specs.weight],
      ["–ü–æ–¥—Å–≤–µ—Ç–∫–∞", p.specs.backlight],
      ["SKU", p.sku],
    ]
    : [
      ["–ë—Ä–µ–Ω–¥", p.brand],
      ["–¢–∏–ø", p.specs.type || p.sub || "‚Äî"],
      ["–î–æ–∫—É–º–µ–Ω—Ç—ã", p.specs.docs || "‚Äî"],
      ["–ì–∞—Ä–∞–Ω—Ç–∏—è", p.specs.warranty || "‚Äî"],
      ["SKU", p.sku],
    ];

  const warningBlock = (p.warning)
    ? `<div class="warnbox">‚ö†Ô∏è <b>–í–∞–∂–Ω–æ:</b> ${p.warning}</div>`
    : "";

  const docsBlock = (p.docs && p.docs.length)
    ? `<div style="margin-top:10px">
         <b style="font-size:13px">–î–æ–∫—É–º–µ–Ω—Ç—ã</b>
         <div class="docs">
           ${p.docs.map(d=>`<a class="doclink" href="#" onclick="alert('–ó–∞–≥–ª—É—à–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞: ${d}'); return false;">üìÑ ${d}</a>`).join("")}
         </div>
       </div>`
    : "";

  const quoteOnly = !!(p.flags && p.flags.quoteOnly);

  const html = `
    <div class="pdp">
      <div class="gal">
        <img src="images/${p.img}" alt="">
      </div>

      <div>
        <h2>${p.name}</h2>
        <div class="muted" style="margin-top:6px">–ê—Ä—Ç–∏–∫—É–ª/SKU: <b>${p.sku}</b></div>

        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center">
          ${stockChip}
          ${p.oldPriceKZT ? `<span class="chip2">üî• –ê–∫—Ü–∏—è</span>` : ""}
          ${quoteOnly ? `<span class="chip2 warn">üßæ ${t.quote}</span>` : ""}
        </div>

        <div class="price" style="margin-top:10px">
          <b id="pdpPrice">${fmtMoney(variants[0].priceKZT, state.cur)}</b>
          ${p.oldPriceKZT ? `<s>${fmtMoney(p.oldPriceKZT, state.cur)}</s>` : ""}
        </div>

        ${preorderLine}

        <div class="box" style="margin-top:10px">
          <b style="font-size:13px">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</b>
          <table class="tbl" style="margin-top:6px">
            ${specsRows.map(([k,v])=>`<tr><td>${k}</td><td><b>${v}</b></td></tr>`).join("")}
          </table>
        </div>

        ${p.cat==="laptops" ? `
          <div class="box" style="margin-top:10px">
            <b style="font-size:13px">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–≤–∞—Ä–∏–∞–Ω—Ç—ã SKU)</b>
            <div class="variantrow">
              <div>
                <label>RAM</label>
                <select id="vRam"></select>
              </div>
              <div>
                <label>SSD</label>
                <select id="vSsd"></select>
              </div>
            </div>
            <div class="muted" style="margin-top:8px; font-size:12px" id="vStock"></div>
          </div>
        ` : ""}

        ${warningBlock}
        ${docsBlock}

        <div class="pdpactions">
          ${quoteOnly
            ? `<button class="cta" type="button" id="pdpQuote">${t.quote}</button>
               <button class="btn" type="button" id="pdpAsk">${t.ask}</button>`
            : `<button class="cta" type="button" id="pdpAdd">${t.buy}</button>
               <button class="btn" type="button" id="pdpBuyNow">${t.buyNow}</button>
               <button class="btn" type="button" id="pdpOne">${t.oneClick}</button>`
          }
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
          <button class="btn mini" type="button" id="pdpWish">${skuInList(state.wish,p.sku) ? "‚òÖ –í –∏–∑–±—Ä–∞–Ω–Ω–æ–º" : "‚òÜ –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"}</button>
          <button class="btn mini" type="button" id="pdpCmp">${skuInList(state.cmp,p.sku) ? "‚úì –í —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏" : "+ –°—Ä–∞–≤–Ω–∏—Ç—å"}</button>
        </div>
      </div>
    </div>
  `;

  modalOpen("–ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞", html);

  // Variant logic
  let chosen = variants[0];
  function updChosen(){
    const priceEl = document.getElementById("pdpPrice");
    if(priceEl) priceEl.textContent = fmtMoney(chosen.priceKZT, state.cur);
    const stockEl = document.getElementById("vStock");
    if(stockEl){
      const s = (chosen.stock==="in") ? (t.in) : (t.pre);
      stockEl.textContent = "–ù–∞–ª–∏—á–∏–µ: " + s + (chosen.stock==="pre" ? " ‚Ä¢ ~8 –¥–Ω–µ–π –¥–æ –ê–ª–º–∞—Ç—ã" : "");
    }
  }

  if(p.cat==="laptops"){
    const ramSel = document.getElementById("vRam");
    const ssdSel = document.getElementById("vSsd");
    const rams = uniq(variants.map(v=>v.ram));
    const ssds = uniq(variants.map(v=>v.ssd));
    ramSel.innerHTML = rams.map(x=>`<option value="${x}">${x}</option>`).join("");
    ssdSel.innerHTML = ssds.map(x=>`<option value="${x}">${x}</option>`).join("");
    ramSel.value = variants[0].ram;
    ssdSel.value = variants[0].ssd;

    function selectVariant(){
      const r = ramSel.value;
      const s = ssdSel.value;
      const found = variants.find(v=>v.ram===r && v.ssd===s) || variants[0];
      chosen = found;
      updChosen();
    }
    ramSel.addEventListener("change", selectVariant);
    ssdSel.addEventListener("change", selectVariant);
    updChosen();
  }

  // Actions
  const wishBtn = document.getElementById("pdpWish");
  const cmpBtn  = document.getElementById("pdpCmp");
  if(wishBtn) wishBtn.addEventListener("click", ()=>{
    addToWish(p.sku);
    wishBtn.textContent = skuInList(state.wish,p.sku) ? "‚òÖ –í –∏–∑–±—Ä–∞–Ω–Ω–æ–º" : "‚òÜ –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ";
  });
  if(cmpBtn) cmpBtn.addEventListener("click", ()=>{
    addToCmp(p.sku);
    cmpBtn.textContent = skuInList(state.cmp,p.sku) ? "‚úì –í —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏" : "+ –°—Ä–∞–≤–Ω–∏—Ç—å";
  });

  const askText = `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –í–æ–ø—Ä–æ—Å –ø–æ —Ç–æ–≤–∞—Ä—É:
${p.name}
SKU: ${p.sku}
–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${p.cat}
–ù–∞–ª–∏—á–∏–µ: ${p.stock==="in" ? t.in : t.pre}
`;

  const quoteText = `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –•–æ—á—É –∑–∞–ø—Ä–æ—Å–∏—Ç—å –ö–ü/–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é:
${p.name}
SKU: ${p.sku}
–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${p.cat}
`;

  const addBtn = document.getElementById("pdpAdd");
  const buyNowBtn = document.getElementById("pdpBuyNow");
  const oneBtn = document.getElementById("pdpOne");
  const qBtn = document.getElementById("pdpQuote");
  const aBtn = document.getElementById("pdpAsk");

  if(addBtn) addBtn.addEventListener("click", ()=>{
    const vid = (p.cat==="laptops") ? chosen.id : "base";
    const vName = (p.cat==="laptops") ? `${chosen.ram} / ${chosen.ssd}` : "";
    addToCart(p, 1, vid, vName);
    alert("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É");
  });
  if(buyNowBtn) buyNowBtn.addEventListener("click", ()=>{
    const vid = (p.cat==="laptops") ? chosen.id : "base";
    const vName = (p.cat==="laptops") ? `${chosen.ram} / ${chosen.ssd}` : "";
    addToCart(p, 1, vid, vName);
    modalClose();
    renderCart();
  });
  if(oneBtn) oneBtn.addEventListener("click", ()=>{
    modalClose();
    openOneClick(p);
  });
  if(qBtn) qBtn.addEventListener("click", ()=> openWA(quoteText));
  if(aBtn) aBtn.addEventListener("click", ()=> openWA(askText));
}

/* ===========================
   One-click flow
   =========================== */
function openOneClick(product=null){
  const t = I18N[state.lang] || I18N.ru;
  const title = product ? `–ö—É–ø–∏—Ç—å –≤ 1 –∫–ª–∏–∫: ${product.name}` : "–ö—É–ø–∏—Ç—å –≤ 1 –∫–ª–∏–∫";
  const html = `
    <div class="card pad" style="box-shadow:none; border-radius:16px; border:1px solid rgba(214,214,214,.75)">
      <b style="font-size:14px">${title}</b>
      <div class="muted" style="margin-top:6px; font-size:12px">
        –û—Å—Ç–∞–≤—å—Ç–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω ‚Äî –º—ã —Å–≤—è–∂–µ–º—Å—è –∏ —É—Ç–æ—á–Ω–∏–º –Ω–∞–ª–∏—á–∏–µ/—Å—Ä–æ–∫–∏.
      </div>
      <div class="formgrid" style="margin-top:12px">
        <div class="field">
          <label>–ò–º—è</label>
          <input id="ocName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–π–±–µ–∫" />
        </div>
        <div class="field">
          <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input id="ocPhone" placeholder="+7 ..." />
        </div>
      </div>
      <div class="field" style="margin-top:10px">
        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
        <input id="ocNote" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –Ω—É–∂–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞, —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è..." />
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
        <button class="cta" type="button" id="ocSend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button class="btn" type="button" id="ocCancel">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  `;
  modalOpen("–ö—É–ø–∏—Ç—å –≤ 1 –∫–ª–∏–∫", html);

  document.getElementById("ocCancel").addEventListener("click", modalClose);
  document.getElementById("ocSend").addEventListener("click", ()=>{
    const name = (document.getElementById("ocName").value || "").trim();
    const phone = (document.getElementById("ocPhone").value || "").trim();
    const note = (document.getElementById("ocNote").value || "").trim();
    const pLine = product ? `–¢–æ–≤–∞—Ä: ${product.name}\nSKU: ${product.sku}\n–¶–µ–Ω–∞: ${fmtMoney(product.priceKZT, state.cur)}\n` : "";
    const msg =
`–ó–∞—è–≤–∫–∞: –ö—É–ø–∏—Ç—å –≤ 1 –∫–ª–∏–∫
${pLine}–ò–º—è: ${name || "-"}
–¢–µ–ª–µ—Ñ–æ–Ω: ${phone || "-"}
–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${note || "-"}
(–°–∞–π—Ç JOHNGALTAZ)`;
    openWA(msg);
  });
}

/* ===========================
   Filters / rendering
   =========================== */

const UI = {
  products: document.getElementById("products"),
  countText: document.getElementById("countText"),
  queryPill: document.getElementById("queryPill"),
  activePill: document.getElementById("activePill"),

  catSel: document.getElementById("catSel"),
  subSel: document.getElementById("subSel"),
  brandSel: document.getElementById("brandSel"),
  minPrice: document.getElementById("minPrice"),
  maxPrice: document.getElementById("maxPrice"),
  onlyInStock: document.getElementById("onlyInStock"),
  showPreorder: document.getElementById("showPreorder"),

  laptopFilters: document.getElementById("laptopFilters"),
  cpuSel: document.getElementById("cpuSel"),
  gpuSel: document.getElementById("gpuSel"),
  ramSel: document.getElementById("ramSel"),
  ssdSel: document.getElementById("ssdSel"),
  inchSel: document.getElementById("inchSel"),
  hzSel: document.getElementById("hzSel"),
  osSel: document.getElementById("osSel"),
  panelSel: document.getElementById("panelSel"),

  searchInput: document.getElementById("searchInput"),
  sortSel: document.getElementById("sortSel"),
};

function fillSelect(sel, values, firstLabel="–í—Å–µ"){
  sel.innerHTML = `<option value="">${firstLabel}</option>` + values.map(v=>`<option value="${v}">${v}</option>`).join("");
}

function syncSubcats(cat){
  const subs = uniq(PRODUCTS.filter(p=>!cat || p.cat===cat).map(p=>p.sub));
  fillSelect(UI.subSel, subs, "–í—Å–µ");
}

function syncBrands(cat){
  const brands = uniq(PRODUCTS.filter(p=>!cat || p.cat===cat).map(p=>p.brand));
  fillSelect(UI.brandSel, brands, "–í—Å–µ");
}

function syncLaptopFacetOptions(){
  const ls = PRODUCTS.filter(p=>p.cat==="laptops");
  fillSelect(UI.cpuSel, uniq(ls.map(p=>p.specs.cpu)), "–õ—é–±–æ–π");
  fillSelect(UI.gpuSel, uniq(ls.map(p=>p.specs.gpu)), "–õ—é–±–æ–π");
  fillSelect(UI.ramSel, uniq(ls.map(p=>p.specs.ram)), "–õ—é–±–∞—è");
  fillSelect(UI.ssdSel, uniq(ls.map(p=>p.specs.ssd)), "–õ—é–±–æ–π");
  fillSelect(UI.inchSel, uniq(ls.map(p=>p.specs.inch)), "–õ—é–±–æ–π");
  fillSelect(UI.hzSel, uniq(ls.map(p=>p.specs.hz)), "–õ—é–±–∞—è");
  fillSelect(UI.osSel, uniq(ls.map(p=>p.specs.os)), "–õ—é–±–∞—è");
  fillSelect(UI.panelSel, uniq(ls.map(p=>p.specs.panel)), "–õ—é–±–∞—è");
}

function getFilters(){
  const q = (UI.searchInput.value || "").trim();
  const cat = UI.catSel.value;
  const sub = UI.subSel.value;
  const brand = UI.brandSel.value;
  const minP = parseInt((UI.minPrice.value||"").replace(/\s/g,""), 10);
  const maxP = parseInt((UI.maxPrice.value||"").replace(/\s/g,""), 10);
  const onlyIn = UI.onlyInStock.checked;
  const showPre = UI.showPreorder.checked;
  const sort = UI.sortSel.value;

  const laptop = {
    cpu: UI.cpuSel.value,
    gpu: UI.gpuSel.value,
    ram: UI.ramSel.value,
    ssd: UI.ssdSel.value,
    inch: UI.inchSel.value,
    hz: UI.hzSel.value,
    os: UI.osSel.value,
    panel: UI.panelSel.value,
  };

  return { q, cat, sub, brand, minP: isNaN(minP)?null:minP, maxP: isNaN(maxP)?null:maxP, onlyIn, showPre, sort, laptop };
}

function setFromQS(){
  const p = qsParse();
  if(p.lang){ state.lang = p.lang; saveState(state); }
  if(p.cur){ state.cur = p.cur; saveState(state); }

  document.getElementById("langSel").value = state.lang;
  document.getElementById("curSel").value = state.cur;

  UI.searchInput.value = p.q || "";
  UI.catSel.value = p.cat || "";
  syncSubcats(UI.catSel.value);
  UI.subSel.value = p.sub || "";
  syncBrands(UI.catSel.value);
  UI.brandSel.value = p.brand || "";
  UI.minPrice.value = p.min || "";
  UI.maxPrice.value = p.max || "";
  UI.onlyInStock.checked = (p.onlyIn==="1");
  UI.showPreorder.checked = (p.showPre==="0") ? false : true; // default true
  UI.sortSel.value = p.sort || "pop";

  // laptop facets
  syncLaptopFacetOptions();
  UI.cpuSel.value = p.cpu || "";
  UI.gpuSel.value = p.gpu || "";
  UI.ramSel.value = p.ram || "";
  UI.ssdSel.value = p.ssd || "";
  UI.inchSel.value = p.inch || "";
  UI.hzSel.value = p.hz || "";
  UI.osSel.value = p.os || "";
  UI.panelSel.value = p.panel || "";

  // open drawers/modal
  if(p.open==="cart") renderCart();
  if(p.open==="oneclick") openOneClick(null);

  // direct open product/wish/cmp
  if(p.wish) openProduct(p.wish);
  if(p.cmp) openProduct(p.cmp);
}

function applyToQS(){
  const f = getFilters();
  qsSet({
    q: f.q || "",
    cat: f.cat || "",
    sub: f.sub || "",
    brand: f.brand || "",
    min: f.minP ?? "",
    max: f.maxP ?? "",
    onlyIn: f.onlyIn ? "1" : "",
    showPre: f.showPre ? "" : "0",
    sort: f.sort || "",
    // laptop
    cpu: (f.cat==="laptops") ? (f.laptop.cpu || "") : "",
    gpu: (f.cat==="laptops") ? (f.laptop.gpu || "") : "",
    ram: (f.cat==="laptops") ? (f.laptop.ram || "") : "",
    ssd: (f.cat==="laptops") ? (f.laptop.ssd || "") : "",
    inch:(f.cat==="laptops") ? (f.laptop.inch|| "") : "",
    hz:  (f.cat==="laptops") ? (f.laptop.hz  || "") : "",
    os:  (f.cat==="laptops") ? (f.laptop.os  || "") : "",
    panel:(f.cat==="laptops") ? (f.laptop.panel|| "") : "",
    // settings
    lang: state.lang,
    cur: state.cur
  });
}

function filterProducts(){
  const f = getFilters();
  const t = I18N[state.lang] || I18N.ru;
  let list = PRODUCTS.slice();

  // category/sub/brand
  if(f.cat) list = list.filter(p=>p.cat===f.cat);
  if(f.sub) list = list.filter(p=>p.sub===f.sub);
  if(f.brand) list = list.filter(p=>p.brand===f.brand);

  // stock
  if(f.onlyIn) list = list.filter(p=>p.stock==="in");
  if(!f.showPre) list = list.filter(p=>p.stock!=="pre");

  // price
  if(f.minP!=null) list = list.filter(p=>p.priceKZT>=f.minP);
  if(f.maxP!=null) list = list.filter(p=>p.priceKZT<=f.maxP);

  // query
  if(f.q){
    const q = f.q.toLowerCase();
    list = list.filter(p=>{
      const blob = (p.name+" "+p.sku+" "+p.brand+" "+(p.cat||"")+" "+(p.sub||"")+" "+JSON.stringify(p.specs||{})).toLowerCase();
      return blob.includes(q);
    });
  }

  // laptop facets
  if(f.cat==="laptops"){
    if(f.laptop.cpu) list = list.filter(p=>p.specs.cpu===f.laptop.cpu);
    if(f.laptop.gpu) list = list.filter(p=>p.specs.gpu===f.laptop.gpu);
    if(f.laptop.ram) list = list.filter(p=>p.specs.ram===f.laptop.ram);
    if(f.laptop.ssd) list = list.filter(p=>p.specs.ssd===f.laptop.ssd);
    if(f.laptop.inch) list = list.filter(p=>p.specs.inch===f.laptop.inch);
    if(f.laptop.hz) list = list.filter(p=>p.specs.hz===f.laptop.hz);
    if(f.laptop.os) list = list.filter(p=>p.specs.os===f.laptop.os);
    if(f.laptop.panel) list = list.filter(p=>p.specs.panel===f.laptop.panel);
  }

  // sort
  if(f.sort==="price_asc") list.sort((a,b)=>a.priceKZT-b.priceKZT);
  if(f.sort==="price_desc") list.sort((a,b)=>b.priceKZT-a.priceKZT);
  if(f.sort==="new") list.sort((a,b)=>b.created-a.created);
  if(f.sort==="pop") list.sort((a,b)=>b.popularity-a.popularity);

  // UI text
  UI.queryPill.textContent = "–ó–∞–ø—Ä–æ—Å: " + (f.q ? `"${f.q}"` : "‚Äî");
  UI.countText.textContent = "–ù–∞–π–¥–µ–Ω–æ: " + list.length;

  // active filter count
  const active = [
    f.q, f.cat, f.sub, f.brand,
    (f.minP!=null ? "min" : ""),
    (f.maxP!=null ? "max" : ""),
    (f.onlyIn ? "onlyIn" : ""),
    (!f.showPre ? "noPre" : ""),
    (f.cat==="laptops" ? f.laptop.cpu : ""),
    (f.cat==="laptops" ? f.laptop.gpu : ""),
    (f.cat==="laptops" ? f.laptop.ram : ""),
    (f.cat==="laptops" ? f.laptop.ssd : ""),
    (f.cat==="laptops" ? f.laptop.inch : ""),
    (f.cat==="laptops" ? f.laptop.hz : ""),
    (f.cat==="laptops" ? f.laptop.os : ""),
    (f.cat==="laptops" ? f.laptop.panel : ""),
  ].filter(Boolean).length;
  UI.activePill.textContent = "–ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã: " + active;

  return list;
}

function cardHTML(p){
  const t = I18N[state.lang] || I18N.ru;

  const stockChip = (p.stock==="in")
    ? `<span class="chip2 ok">‚úÖ ${t.in}</span>`
    : `<span class="chip2 warn">‚è≥ ${t.pre}</span>`;

  const keySpecs = (p.cat==="laptops")
    ? [
      `CPU: ${p.specs.cpu}`,
      `GPU: ${p.specs.gpu}`,
      `RAM: ${p.specs.ram}`,
      `SSD: ${p.specs.ssd}`,
      `${p.specs.inch}" ‚Ä¢ ${p.specs.hz}Hz`
    ]
    : [
      p.specs.type ? `–¢–∏–ø: ${p.specs.type}` : "",
      p.specs.power ? `–ú–æ—â–Ω–æ—Å—Ç—å: ${p.specs.power}` : "",
      p.specs.connection ? `–°–≤—è–∑—å: ${p.specs.connection}` : "",
      p.specs.warranty ? `–ì–∞—Ä–∞–Ω—Ç–∏—è: ${p.specs.warranty}` : "",
      p.specs.docs ? `–î–æ–∫—É–º–µ–Ω—Ç—ã: –µ—Å—Ç—å` : "",
    ].filter(Boolean).slice(0,4);

  const preorderLine = (p.stock==="pre")
    ? `<div class="preorderline">${t.preorderLine}</div>`
    : "";

  const sale = p.oldPriceKZT ? Math.round((1 - p.priceKZT/p.oldPriceKZT)*100) : null;

  return `
    <article class="p" data-sku="${p.sku}">
      <div style="position:relative">
        ${sale ? `<div class="sticker">-${Math.abs(sale)}%</div>` : ""}
        <img class="pimg" src="images/${p.img}" alt="${p.name}">
      </div>

      <div class="pbody">
        <h3 class="pname">${p.name}</h3>
        <div class="psku">SKU: <b>${p.sku}</b></div>

        <div class="pmeta">
          ${stockChip}
          <span class="chip2">üè∑Ô∏è ${p.brand}</span>
          ${p.flags.quoteOnly ? `<span class="chip2 warn">üßæ ${t.quote}</span>` : ""}
        </div>

        ${keySpecs.length ? `
          <div class="specs">
            ${keySpecs.map(s=>`<div>${s}</div>`).join("")}
          </div>
        ` : ""}

        <div class="price">
          <b>${fmtMoney(p.priceKZT, state.cur)}</b>
          ${p.oldPriceKZT ? `<s>${fmtMoney(p.oldPriceKZT, state.cur)}</s>` : ""}
        </div>

        ${preorderLine}

        <div class="pactions">
          ${p.flags.quoteOnly
            ? `<button class="cta" type="button" data-act="quote">–ó–∞–ø—Ä–æ—Å –ö–ü</button>`
            : `<button class="cta" type="button" data-act="add">–í –∫–æ—Ä–∑–∏–Ω—É</button>`
          }
          <button class="btn" type="button" data-act="open">–û—Ç–∫—Ä—ã—Ç—å</button>
        </div>

        <div class="iconbar">
          <button class="iconbtn" type="button" data-act="wish" aria-label="–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">
            ${state.wish.includes(p.sku) ? "‚òÖ" : "‚òÜ"}
          </button>
          <button class="iconbtn" type="button" data-act="cmp" aria-label="–°—Ä–∞–≤–Ω–∏—Ç—å">
            ${state.cmp.includes(p.sku) ? "‚úì" : "+"}
          </button>
          <button class="iconbtn" type="button" data-act="one" aria-label="–ö—É–ø–∏—Ç—å –≤ 1 –∫–ª–∏–∫">‚ö°</button>
        </div>
      </div>
    </article>
  `;
}

function render(){
  applyI18N();
  setCounts();

  // show/hide laptop filters
  const cat = UI.catSel.value;
  UI.laptopFilters.style.display = (cat==="laptops") ? "block" : "none";

  // sync selects on category
  syncSubcats(cat);
  syncBrands(cat);

  const list = filterProducts();
  UI.products.innerHTML = list.map(cardHTML).join("");

  // Update crumbs/title
  const mapName = {
    "": "–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤",
    "laptops": "–ò–≥—Ä–æ–≤—ã–µ –Ω–æ—É—Ç–±—É–∫–∏",
    "periphery": "–ü–µ—Ä–∏—Ñ–µ—Ä–∏—è",
    "home": "–ú–µ–ª–∫–æ-–±—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞",
    "cosmo": "–ö–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ",
    "medical": "–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"
  };
  document.getElementById("pageTitle").textContent = mapName[cat || ""] || "–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤";
}

/* ===========================
   Events
   =========================== */

document.getElementById("langSel").value = state.lang;
document.getElementById("curSel").value = state.cur;

document.getElementById("langSel").addEventListener("change", (e)=>{
  state.lang = e.target.value;
  saveState(state);
  applyToQS();
  render();
});
document.getElementById("curSel").addEventListener("change", (e)=>{
  state.cur = e.target.value;
  saveState(state);
  applyToQS();
  render();
});

document.getElementById("hambBtn").addEventListener("click", ()=>{
  const nav = document.getElementById("nav");
  nav.classList.toggle("open");
});

document.getElementById("doSearch").addEventListener("click", ()=>{
  applyToQS();
  render();
});
document.getElementById("searchInput").addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){ e.preventDefault(); document.getElementById("doSearch").click(); }
});

document.getElementById("sortSel").addEventListener("change", ()=>{
  applyToQS();
  render();
});

document.getElementById("applyBtn").addEventListener("click", ()=>{
  applyToQS();
  render();
});

document.getElementById("resetBtn").addEventListener("click", ()=>{
  UI.searchInput.value = "";
  UI.catSel.value = "";
  syncSubcats("");
  UI.subSel.value = "";
  syncBrands("");
  UI.brandSel.value = "";
  UI.minPrice.value = "";
  UI.maxPrice.value = "";
  UI.onlyInStock.checked = false;
  UI.showPreorder.checked = true;
  UI.sortSel.value = "pop";

  UI.cpuSel.value = "";
  UI.gpuSel.value = "";
  UI.ramSel.value = "";
  UI.ssdSel.value = "";
  UI.inchSel.value = "";
  UI.hzSel.value = "";
  UI.osSel.value = "";
  UI.panelSel.value = "";

  applyToQS();
  render();
});

UI.catSel.addEventListener("change", ()=>{
  syncSubcats(UI.catSel.value);
  syncBrands(UI.catSel.value);
  render();
});

document.getElementById("openFiltersMobile").addEventListener("click", ()=>{
  // –Ω–∞ –º–æ–±–∏–ª–∫–µ –ø—Ä–æ—Å—Ç–æ —Å–∫—Ä–æ–ª–ª–∏–º –∫ —Ñ–∏–ª—å—Ç—Ä–∞–º
  document.getElementById("filtersCard").scrollIntoView({behavior:"smooth"});
});

document.querySelectorAll(".gtitle button[data-toggle]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const key = btn.dataset.toggle;
    const box = document.querySelector(`[data-box="${key}"]`);
    if(!box) return;
    const isHidden = box.style.display==="none";
    box.style.display = isHidden ? "" : "none";
    btn.textContent = isHidden ? "‚ñæ" : "‚ñ∏";
  });
});

document.querySelectorAll(".tagrow .tag").forEach(tag=>{
  tag.addEventListener("click", ()=>{
    const qcat = tag.dataset.qcat;
    const reset = tag.dataset.qreset;
    if(reset){
      UI.catSel.value = "";
    } else if(qcat){
      UI.catSel.value = qcat;
    }
    syncSubcats(UI.catSel.value);
    syncBrands(UI.catSel.value);
    applyToQS();
    render();
  });
});

document.getElementById("cartBtn").addEventListener("click", renderCart);
document.getElementById("wishBtn").addEventListener("click", renderWish);
document.getElementById("cmpBtn").addEventListener("click", renderCompare);
document.getElementById("openCompare").addEventListener("click", renderCompare);
document.getElementById("openOneClick").addEventListener("click", ()=>openOneClick(null));

document.getElementById("openCartFromCheckout").addEventListener("click", renderCart);

document.getElementById("fabWA").addEventListener("click", ()=>{
  openWA("–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ù—É–∂–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ø–æ —Ç–æ–≤–∞—Ä–∞–º JOHNGALTAZ.");
});

document.getElementById("products").addEventListener("click", (e)=>{
  const card = e.target.closest(".p");
  if(!card) return;
  const sku = card.dataset.sku;
  const p = PRODUCTS.find(x=>x.sku===sku);
  if(!p) return;

  const actBtn = e.target.closest("button[data-act]");
  if(!actBtn){
    // –∫–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ –Ω–µ –Ω–∞ –∫–Ω–æ–ø–∫–µ ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ–º
    openProduct(sku);
    return;
  }
  const act = actBtn.dataset.act;
  if(act==="open") openProduct(sku);
  if(act==="wish") addToWish(sku);
  if(act==="cmp") addToCmp(sku);
  if(act==="one") openOneClick(p);

  if(act==="add"){
    addToCart(p, 1, "base", "");
    alert("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É");
  }
  if(act==="quote"){
    openWA(`–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –•–æ—á—É –∑–∞–ø—Ä–æ—Å–∏—Ç—å –ö–ü/–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é:\n${p.name}\nSKU: ${p.sku}\n–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${p.cat}\n(–°–∞–π—Ç JOHNGALTAZ)`);
  }
});

document.getElementById("isB2B").addEventListener("change", (e)=>{
  document.getElementById("b2bFields").style.display = e.target.checked ? "block" : "none";
});

document.getElementById("checkoutForm").addEventListener("submit", (e)=>{
  e.preventDefault();
  const t = I18N[state.lang] || I18N.ru;

  if(!state.cart.length){
    alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è. –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã.");
    return;
  }

  const name = document.getElementById("cName").value.trim();
  const phone = document.getElementById("cPhone").value.trim();
  const city = document.getElementById("cCity").value.trim();
  const addr = document.getElementById("cAddr").value.trim();
  const ship = document.getElementById("cShip").value;
  const pay = document.getElementById("cPay").value;
  const comment = document.getElementById("cComment").value.trim();

  const isB2B = document.getElementById("isB2B").checked;
  const bCompany = document.getElementById("bCompany").value.trim();
  const bBin = document.getElementById("bBin").value.trim();
  const bAddr = document.getElementById("bAddr").value.trim();
  const bEmail = document.getElementById("bEmail").value.trim();
  const file = document.getElementById("bFile").files[0];

  const shipMap = { curier:"–ö—É—Ä—å–µ—Ä", pickup:"–°–∞–º–æ–≤—ã–≤–æ–∑", post:"–ö–∞–∑–ø–æ—á—Ç–∞/–¥–æ—Å—Ç–∞–≤–∫–∞", sdek:"–°–î–≠–ö", boxberry:"Boxberry" };
  const payMap = { kaspi:"Kaspi", card:"–ö–∞—Ä—Ç–∞", transfer:"–ü–µ—Ä–µ–≤–æ–¥", online:"–û–Ω–ª–∞–π–Ω-—ç–∫–≤–∞–π—Ä–∏–Ω–≥" };

  const lines = state.cart.map((it, idx)=> {
    const p = PRODUCTS.find(x=>x.sku===it.sku);
    const lead = (p && p.stock==="pre") ? " ‚Ä¢ ~8 –¥–Ω–µ–π –¥–æ –ê–ª–º–∞—Ç—ã" : "";
    return `${idx+1}) ${it.name} (${it.sku}) ${it.variantName?("["+it.variantName+"]"):""} ‚Äî ${it.qty} —à—Ç ‚Äî ${fmtMoney(it.priceKZT, state.cur)}${lead}`;
  });

  const totalKZT = state.cart.reduce((sum,it)=>sum + (it.priceKZT||0)*it.qty, 0);

  const b2bBlock = isB2B ? `
–Æ—Ä. –ª–∏—Ü–æ: –î–∞
–ö–æ–º–ø–∞–Ω–∏—è: ${bCompany || "-"}
–ë–ò–ù/–ò–ù–ù: ${bBin || "-"}
–Æ—Ä. –∞–¥—Ä–µ—Å: ${bAddr || "-"}
Email: ${bEmail || "-"}
–§–∞–π–ª —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤: ${file ? file.name : "–Ω–µ—Ç"}
` : `–Æ—Ä. –ª–∏—Ü–æ: –ù–µ—Ç`;

  const msg =
`–ó–∞–∫–∞–∑ / –∑–∞—è–≤–∫–∞ (JOHNGALTAZ)
–§–ò–û: ${name}
–¢–µ–ª–µ—Ñ–æ–Ω: ${phone}
–ì–æ—Ä–æ–¥: ${city}
–ê–¥—Ä–µ—Å: ${addr}
–î–æ—Å—Ç–∞–≤–∫–∞: ${shipMap[ship] || ship}
–û–ø–ª–∞—Ç–∞: ${payMap[pay] || pay}
–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${comment || "-"}
${b2bBlock}

–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:
${lines.join("\n")}

–ò—Ç–æ–≥–æ: ${fmtMoney(totalKZT, state.cur)}

–°—Ç–∞—Ç—É—Å: –Ω–æ–≤—ã–π (—Ç–µ—Å—Ç–æ–≤—ã–π —Å–∞–π—Ç)
`;

  openWA(msg);
});

/* ===========================
   Init
   =========================== */
function initFacets(){
  syncLaptopFacetOptions();
  syncSubcats("");
  syncBrands("");
}
initFacets();
setFromQS();
applyI18N();
setCounts();
render();

/* Apply settings + deep links from QS after render */
(function(){
  const p = qsParse();
  if(p.cat){ UI.catSel.value = p.cat; syncSubcats(p.cat); syncBrands(p.cat); }
  // search pill
  const qv = (UI.searchInput.value||"").trim();
  UI.queryPill.textContent = "–ó–∞–ø—Ä–æ—Å: " + (qv ? `"${qv}"` : "‚Äî");

  // open product by sku
  if(p.sku){ openProduct(p.sku); }

  // if external wants to open cart/oneclick already handled in setFromQS
})();

</script>
</body>
</html>
